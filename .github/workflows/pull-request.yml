name: ğŸ”¥ Pull requests

on:
  pull_request:
  push:

permissions:
  contents: read
  pull-requests: write

env:
  CI: 1
  ARTIFACT_DIR: ./artifacts

jobs:
  danger:
    name: ğŸ”¥ Danger
    runs-on: ubuntu-latest
    steps:
      - name: â¬‡ï¸ Checkout branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - uses: ./.github/common-actions/install

      - name: ğŸ”¨ Build
        run: pnpm build

      - name: ğŸ”¥ Run Danger
        run: npx danger ci --use-github-checks
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“¤ Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: danger-artifacts
          path: ${{ env.ARTIFACT_DIR }}


  tests:
    name: ğŸ§ª Tests
    runs-on: ubuntu-latest
    steps:
      - name: â¬‡ï¸ Checkout branch
        uses: actions/checkout@v4

      - name: ğŸ“¥ Setup
        uses: ./.github/common-actions/install

      - name: ğŸ§ª Run tests
        run: pnpm test

  eslint:
    name: â¬£ ESLint
    runs-on: ubuntu-latest
    steps:
      - name: â¬‡ï¸ Checkout branch
        uses: actions/checkout@v4

      - name: ğŸ“¥ Setup
        uses: ./.github/common-actions/install

      - name: ğŸ”¬ Lint
        run: pnpm lint

  types:
    name: Ê¦ TypeScript
    runs-on: ubuntu-latest
    steps:
      - name: â¬‡ï¸ Checkout branch
        uses: actions/checkout@v4

      - name: ğŸ“¥ Setup
        uses: ./.github/common-actions/install

      - name: ğŸ” Type check
        run: pnpm typecheck

  prettier:
    name: ğŸ“ Prettier
    runs-on: ubuntu-latest
    steps:
      - name: â¬‡ï¸ Checkout branch
        uses: actions/checkout@v4

      - name: ğŸ“¥ Setup
        uses: ./.github/common-actions/install

      - name: ğŸ“ Run prettier
        run: pnpm format

  continuous-release:
    name: ğŸ¦‹ Continuous Release
    if: github.repository == 'rajzik/configs'
    runs-on: ubuntu-latest
    steps:
      - name: â¬‡ï¸ Checkout branch
        uses: actions/checkout@v4

      - name: ğŸ“¥ Setup
        uses: ./.github/common-actions/install

      - name: ğŸš€ PR Release
        run: pnpx pkg-pr-new publish --pnpm './packages/*'